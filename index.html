<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gu√≠a de Estudio - Dilo con Movimiento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Todos los estilos CSS anteriores se mantienen igual */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --brand-bg: #1a1a1d;
            --brand-surface: #2a2a2d;
            --brand-text: #f0f0f0;
            --brand-primary: #c3073f;
            --brand-secondary: #950740;
            --bot-bubble: #3b3b3f;
            --user-bubble: #c3073f;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: #1a1a1d;
            color: #f0f0f0;
            height: 100vh;
        }
        
        /* ... (todos los dem√°s estilos se mantienen igual) ... */
        
    </style>
</head>
<body class="h-full bg-[#1a1a1d] text-[#f0f0f0] flex items-center justify-center p-1 sm:p-4">
    <div class="flex flex-col w-full max-w-2xl h-full max-h-[95vh] bg-[#2a2a2d] rounded-2xl shadow-2xl overflow-hidden border border-[#1a1a1d]">
        <header class="bg-[#1a1a1d] p-3 flex items-center justify-between border-b border-[#1a1a1d] shadow-md">
            <div class="flex items-center space-x-2 flex-1 min-w-0">
                <div class="p-1 bg-[#c3073f] rounded-full flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
                        <path d="M15.07 13.09a7 7 0 0 0-4.14 4.17"/>
                        <path d="M18.81 9.26a11.08 11.08 0 0 0-1.07-2.61"/>
                        <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10c0-1.76-.44-3.41-1.22-4.88"/>
                        <path d="M19.88 5.12A10 10 0 0 0 12 2v0"/>
                        <path d="m10.12 7.2-.62-2.01"/>
                        <path d="m5.2 11.2-.5 1.6"/>
                        <path d="m4.61 6.1-.9 1.2"/>
                        <path d="M9.82 17.18a7 7 0 0 0 4.14-4.17"/>
                        <path d="M5.19 18.74A11.08 11.08 0 0 0 6.26 21.35"/>
                        <path d="M12 22v0c5.5 0 10-4.5 10-10 0-1.76-.44-3.41-1.22-4.88"/>
                        <path d="M4.12 18.88A10 10 0 0 0 12 22v0"/>
                        <path d="m13.88 16.8.62 2.01"/>
                        <path d="m18.8 12.8.5-1.6"/>
                        <path d="m19.39 17.9.9-1.2"/>
                    </svg>
                </div>
                <div class="min-w-0 flex-1">
                    <h1 class="text-base font-bold truncate">Gu√≠a: Circo Urbano</h1>
                    <p class="text-xs text-gray-400 truncate">Dilo con Movimiento</p>
                </div>
            </div>
            <div class="text-xs text-gray-400 text-right flex-shrink-0 pl-2">
                <p class="font-bold text-[#c3073f]">GALA FINAL</p>
                <p id="current-date">10 Ene</p>
            </div>
        </header>

        <div id="chat-container" class="flex-1 p-2 sm:p-4 md:p-6 space-y-3 overflow-y-auto">
            <!-- Mensaje de carga -->
            <div class="chat-bubble max-w-[90%] sm:max-w-[85%] bg-[#3b3b3f] p-3 rounded-2xl rounded-tl-none">
                <p class="font-semibold text-[#c3073f]">Cargando gu√≠a...</p>
                <p class="mt-1">Por favor espera mientras se cargan los datos actualizados.</p>
            </div>
        </div>

        <footer class="bg-[#1a1a1d] p-2 sm:p-4 border-t border-[#1a1a1d]">
            <form id="chat-form" class="flex items-center space-x-2 mb-2">
                <input 
                    type="text" 
                    id="user-input"
                    placeholder="Escribe tu pregunta..."
                    class="flex-1 p-2 bg-[#2a2a2d] border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#c3073f] text-[#f0f0f0] placeholder-gray-500 text-sm"
                    autocomplete="off"
                    disabled
                >
                <button 
                    type="submit"
                    class="p-2 bg-[#c3073f] text-white rounded-xl hover:bg-[#950740] focus:outline-none focus:ring-2 focus:ring-[#c3073f] transition-colors duration-200 flex-shrink-0"
                    disabled
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </form>
            <div class="footer-buttons flex flex-wrap gap-1 justify-center">
                <!-- Los botones se habilitar√°n despu√©s de cargar -->
            </div>
        </footer>
    </div>

    <script>
        // Estado de la conversaci√≥n
        const chatState = {
            currentTopic: null,
            previousTopic: null,
            messages: [],
            conceptsDiscussed: new Set(),
            history: [],
            knowledgeBase: null,
            isLoaded: false
        };

        // URLs de datos
        const JSON_URL = 'https://gist.githubusercontent.com/danyeltrainer/fee9da8385eaedaa15ccfc150f442a65/raw/29fa4a7d152e3617c28345a9727cd76c7d66aea4/datos.json';

        // Funci√≥n para cargar datos desde JSON
        async function loadKnowledgeBase() {
            try {
                const response = await fetch(JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const jsonData = await response.json();
                return transformJSONToKnowledgeBase(jsonData);
            } catch (error) {
                console.error('Error loading JSON:', error);
                // En caso de error, usar datos por defecto
                return getDefaultKnowledgeBase();
            }
        }

        // Funci√≥n para transformar el JSON a la estructura de knowledgeBase
        function transformJSONToKnowledgeBase(jsonData) {
            const kb = {};
            
            // Transformar eventos a anuncios
            if (jsonData.eventos && Array.isArray(jsonData.eventos)) {
                kb.anuncios = {
                    titulo: '<h3 class="font-bold text-[#c3073f] text-sm">üì£ ANUNCIOS Y EVENTOS</h3>',
                    contenido: jsonData.eventos.map(evento => `
                        <div class="announcement-card">
                            <h4 class="font-bold text-sm">${evento.fecha}: ${evento.titulo}</h4>
                            <p class="text-xs mt-1">${evento.descripcion}</p>
                            ${evento.link ? `<a href="${evento.link}" target="_blank" class="video-link mt-1 block text-xs">üì∑ Ver en Instagram</a>` : ''}
                        </div>
                    `).join(''),
                    pregunta: '¬øNecesitas informaci√≥n sobre alg√∫n otro tema?',
                    navButtons: true
                };
            }

            // Transformar normas
            if (jsonData.normas) {
                kb.normas = {
                    titulo: '<h3 class="font-bold text-[#10b981] text-sm">üìú NUESTRAS NORMAS COMUNITARIAS</h3>',
                    contenido: `
                        <div class="rules-card">
                            <div class="safety-warning text-xs">
                                <p class="font-bold text-red-400">‚ö†Ô∏è ATENCI√ìN: ACTIVIDADES DE RIESGO</p>
                                <p class="mt-1">${jsonData.normas.advertencia}</p>
                            </div>
                            
                            <h4 class="font-bold mb-1 mt-2 text-sm">Para mantener un espacio seguro y respetuoso:</h4>
                            <ul class="list-disc list-inside mt-1 space-y-1 text-xs">
                                ${jsonData.normas.reglas.map(regla => `<li>${regla}</li>`).join('')}
                            </ul>
                        </div>
                    `,
                    pregunta: '¬øNecesitas informaci√≥n sobre alg√∫n otro tema?',
                    navButtons: true
                };
            }

            // Transformar factores del esfuerzo
            if (jsonData.factores_esfuerzo) {
                Object.keys(jsonData.factores_esfuerzo).forEach(factorKey => {
                    const factor = jsonData.factores_esfuerzo[factorKey];
                    const polaridades = Object.keys(factor.polaridades || {});
                    
                    kb[factorKey] = {
                        titulo: `<h3 class="font-bold text-[#c3073f] text-sm">${factor.emoji} FACTOR: ${factor.nombre.toUpperCase()}</h3>`,
                        contenido: `
                            <div class="content-section">
                                <p class="text-sm">${factor.descripcion}</p>
                            </div>
                            
                            ${polaridades.map(polaridadKey => {
                                const polaridad = factor.polaridades[polaridadKey];
                                return `
                                    <div class="mt-2 example-card content-section">
                                        <h4 class="font-bold text-sm">${polaridad.nombre}</h4>
                                        <p class="text-xs mt-1">${polaridad.descripcion}</p>
                                        ${polaridad.ejemplos && polaridad.ejemplos.length > 0 ? `
                                            <div class="mt-1 flex flex-wrap">
                                                ${polaridad.ejemplos.map(ejemplo => 
                                                    `<a href="${ejemplo.link}" target="_blank" class="video-link text-xs">${ejemplo.titulo}</a>`
                                                ).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        `,
                        pregunta: '¬øQuieres explorar otro factor?',
                        navButtons: true
                    };
                });
            }

            // Transformar personajes
            if (jsonData.personajes) {
                // Personajes principales
                if (jsonData.personajes.personajes) {
                    kb.personajes = {
                        titulo: '<h3 class="font-bold text-[#3a86ff] text-sm">üé≠ CONSTRUCCI√ìN DE PERSONAJES</h3>',
                        contenido: `
                            <div class="content-section">
                                <p class="text-sm">${jsonData.personajes.personajes.descripcion}</p>
                            </div>
                            
                            ${jsonData.personajes.personajes.tipos.map(tipo => `
                                <div class="mt-2 character-card content-section">
                                    <h4 class="font-bold text-sm">${tipo.emoji} ${tipo.nombre}</h4>
                                    <p class="text-xs mt-1">${tipo.descripcion}</p>
                                    <div class="mt-1">
                                        ${tipo.elementos.map(elemento => 
                                            `<span class="element-tag ${elemento}">${elemento}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        `,
                        pregunta: '¬øQuieres explorar m√°s sobre motores de movimiento o elementos?',
                        navButtons: true
                    };
                }

                // Motores
                if (jsonData.personajes.motores) {
                    kb.motores = {
                        titulo: '<h3 class="font-bold text-[#3a86ff] text-sm">‚öôÔ∏è MOTORES DE MOVIMIENTO</h3>',
                        contenido: `
                            <div class="content-section">
                                <p class="text-sm">${jsonData.personajes.motores.descripcion}</p>
                            </div>
                            
                            ${jsonData.personajes.motores.tipos.map(motor => `
                                <div class="mt-2 character-card content-section">
                                    <h4 class="font-bold text-sm">${motor.emoji} ${motor.nombre}</h4>
                                    <p class="text-xs mt-1">${motor.descripcion}</p>
                                </div>
                            `).join('')}
                        `,
                        pregunta: '¬øQuieres explorar los elementos o volver a los personajes?',
                        navButtons: true
                    };
                }

                // Elementos
                if (jsonData.personajes.elementos) {
                    kb.elementos = {
                        titulo: '<h3 class="font-bold text-[#3a86ff] text-sm">üåä ELEMENTOS</h3>',
                        contenido: `
                            <div class="content-section">
                                <p class="text-sm">${jsonData.personajes.elementos.descripcion}</p>
                            </div>
                            
                            ${jsonData.personajes.elementos.tipos.map(elemento => `
                                <div class="mt-2 character-card content-section">
                                    <h4 class="font-bold text-sm"><span class="element-tag ${elemento.nombre.toLowerCase()}">${elemento.nombre.toUpperCase()}</span></h4>
                                    <p class="text-xs mt-1">${elemento.descripcion}</p>
                                </div>
                            `).join('')}
                        `,
                        pregunta: '¬øQuieres explorar los motores de movimiento o volver a los personajes?',
                        navButtons: true
                    };
                }
            }

            // Transformar herramientas
            if (jsonData.herramientas) {
                // Tabla resumen
                if (jsonData.herramientas.tabla_resumen) {
                    kb.tabla_resumen = {
                        titulo: '<h3 class="font-bold text-[#c3073f] text-sm">üìä TABLA RESUMEN</h3>',
                        contenido: `
                            <div class="content-section">
                                <p class="text-sm">${jsonData.herramientas.tabla_resumen.descripcion}</p>
                            </div>
                            
                            <div class="overflow-x-auto mt-2">
                                <table class="w-full text-xs text-left">
                                    <thead class="bg-[#1a1a1d]">
                                        <tr>
                                            ${jsonData.herramientas.tabla_resumen.columnas.map(col => 
                                                `<th class="p-1 font-bold">${col}</th>`
                                            ).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${jsonData.herramientas.tabla_resumen.filas.map(fila => `
                                            <tr class="border-b border-gray-700">
                                                ${fila.map((celda, index) => 
                                                    `<td class="p-1 ${index === 0 ? 'font-medium' : ''}">${celda}</td>`
                                                ).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `,
                        pregunta: '¬øQuieres explorar alg√∫n factor en particular?',
                        navButtons: true
                    };
                }

                // Tabla s√≠ntesis
                if (jsonData.herramientas.tabla_sintesis) {
                    kb.tabla_sintesis = {
                        titulo: '<h3 class="font-bold text-[#c3073f] text-sm">üîó TABLA DE S√çNTESIS</h3>',
                        contenido: `
                            <div class="content-section">
                                <p class="text-sm">${jsonData.herramientas.tabla_sintesis.descripcion}</p>
                            </div>
                            
                            <div class="overflow-x-auto mt-2">
                                <table class="w-full text-xs text-left">
                                    <thead class="bg-[#1a1a1d]">
                                        <tr>
                                            ${jsonData.herramientas.tabla_sintesis.columnas.map(col => 
                                                `<th class="p-1 font-bold">${col}</th>`
                                            ).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${jsonData.herramientas.tabla_sintesis.filas.map(fila => `
                                            <tr class="border-b border-gray-700">
                                                ${fila.map(celda => 
                                                    `<td class="p-1">${celda}</td>`
                                                ).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `,
                        pregunta: '¬øQuieres explorar m√°s sobre alg√∫n componente?',
                        navButtons: true
                    };
                }

                // Conocimientos de apoyo
                if (jsonData.herramientas.conocimientos_apoyo) {
                    kb.conocimientos_apoyo = {
                        titulo: '<h3 class="font-bold text-[#3a86ff] text-sm">üí™ CONOCIMIENTOS DE APOYO</h3>',
                        contenido: `
                            <div class="content-section">
                                <p class="text-sm">${jsonData.herramientas.conocimientos_apoyo.descripcion}</p>
                            </div>
                            
                            ${jsonData.herramientas.conocimientos_apoyo.categorias.map(categoria => `
                                <div class="mt-2 character-card content-section">
                                    <h4 class="font-bold text-sm">${categoria.nombre}</h4>
                                    <div class="mt-1 space-y-1">
                                        ${categoria.contenidos.map(contenido => {
                                            if (contenido.tipo === 'link') {
                                                return `<a href="${contenido.url}" target="_blank" class="video-link block text-center text-xs">${contenido.titulo}</a>`;
                                            } else {
                                                return `<div class="video-link block text-center text-xs bg-gray-600">${contenido.titulo} - Pendiente link</div>`;
                                            }
                                        }).join('')}
                                    </div>
                                </div>
                            `).join('')}
                            
                            <div class="mt-2 character-card content-section">
                                <h4 class="font-bold text-sm">üé• EJEMPLOS INTEGRADORES</h4>
                                <p class="text-xs mt-1">Aplicaci√≥n completa de todas las t√©cnicas:</p>
                                <div class="mt-1 flex flex-wrap">
                                    ${jsonData.herramientas.conocimientos_apoyo.ejemplos_integradores.map(ejemplo => 
                                        `<a href="${ejemplo.link}" target="_blank" class="video-link text-xs">${ejemplo.titulo}</a>`
                                    ).join('')}
                                </div>
                            </div>
                        `,
                        pregunta: '¬øNecesitas repasar alg√∫n movimiento espec√≠fico?',
                        navButtons: true
                    };
                }
            }

            // Transformar tareas
            if (jsonData.tareas) {
                // Tareas breaking
                if (jsonData.tareas.breaking) {
                    kb.tareas_breaking = {
                        titulo: '<h3 class="font-bold text-[#c3073f] text-sm">üîÑ TAREAS - BREAKING</h3>',
                        contenido: `
                            <div class="task-card breaking-task">
                                <h4 class="font-bold text-sm">üìù TAREAS ACTUALES - BREAKING</h4>
                                <ol class="list-decimal list-inside mt-1 space-y-1 text-xs">
                                    ${jsonData.tareas.breaking.tareas.map(tarea => `<li>${tarea}</li>`).join('')}
                                </ol>
                            </div>
                            
                            ${jsonData.tareas.breaking.musica ? `
                            <div class="mt-2 task-card breaking-task">
                                <h4 class="font-bold text-sm">üéµ M√öSICA ACTUAL - BREAKING</h4>
                                <a href="${jsonData.tareas.breaking.musica}" 
                                   class="block mt-1 p-1 bg-[#1a1a1d] rounded text-blue-400 underline text-xs text-center"
                                   target="_blank">
                                   üéß M√∫sica Breaking - YouTube
                                </a>
                            </div>
                            ` : ''}
                        `,
                        pregunta: '¬øQuieres ver las tareas de otra disciplina?',
                        navButtons: true
                    };
                }

                // Tareas lira
                if (jsonData.tareas.lira) {
                    kb.tareas_lira = {
                        titulo: '<h3 class="font-bold text-[#3a86ff] text-sm">üé™ TAREAS - LIRA</h3>',
                        contenido: `
                            <div class="task-card lira-task">
                                <h4 class="font-bold text-sm">üìù TAREAS ACTUALES - LIRA</h4>
                                <ol class="list-decimal list-inside mt-1 space-y-1 text-xs">
                                    ${jsonData.tareas.lira.tareas.map(tarea => `<li>${tarea}</li>`).join('')}
                                </ol>
                            </div>
                            
                            ${jsonData.tareas.lira.musica ? `
                            <div class="mt-2 task-card lira-task">
                                <h4 class="font-bold text-sm">üéµ M√öSICA ACTUAL - LIRA</h4>
                                <a href="${jsonData.tareas.lira.musica}" 
                                   class="block mt-1 p-1 bg-[#1a1a1d] rounded text-blue-400 underline text-xs text-center"
                                   target="_blank">
                                   üéß Playlist Completa - YouTube
                                </a>
                            </div>
                            ` : ''}
                        `,
                        pregunta: '¬øQuieres ver las tareas de otra disciplina?',
                        navButtons: true
                    };
                }

                // Tareas equipo
                if (jsonData.tareas.equipo) {
                    kb.tareas_equipo = {
                        titulo: '<h3 class="font-bold text-[#10b981] text-sm">üë• TAREAS - EQUIPO COMPLETO</h3>',
                        contenido: `
                            <div class="task-card team-task">
                                <h4 class="font-bold text-sm">üìù TAREAS GRUPALES</h4>
                                <ol class="list-decimal list-inside mt-1 space-y-1 text-xs">
                                    ${jsonData.tareas.equipo.tareas.map(tarea => `<li>${tarea}</li>`).join('')}
                                </ol>
                            </div>
                        `,
                        pregunta: '¬øQuieres ver las tareas de alguna disciplina espec√≠fica?',
                        navButtons: true
                    };
                }

                // Tareas √≠ndice
                kb.tareas = {
                    titulo: '<h3 class="font-bold text-[#c3073f] text-sm">üìã TAREAS</h3>',
                    contenido: `
                        <div class="content-section">
                            <p class="text-sm">Aqu√≠ encontrar√°s las tareas organizadas por disciplina.</p>
                        </div>
                        
                        <div class="flex flex-wrap gap-1 mb-2">
                            <button class="action-button text-xs" onclick="sendMessage('tareas breaking')">Breaking</button>
                            <button class="action-button text-xs" onclick="sendMessage('tareas lira')">Lira</button>
                            <button class="action-button text-xs" onclick="sendMessage('tareas equipo')">Equipo</button>
                        </div>
                        
                        <div class="task-card breaking-task">
                            <h4 class="font-bold text-sm">üîÑ BREAKING</h4>
                            <p class="text-xs mt-1">Tareas actuales para breaking:</p>
                            <ol class="list-decimal list-inside mt-1 space-y-1 text-xs">
                                ${jsonData.tareas.breaking.tareas.slice(0, 3).map(tarea => `<li>${tarea}</li>`).join('')}
                            </ol>
                        </div>
                    `,
                    pregunta: '¬øQuieres ver las tareas de alguna disciplina en particular?',
                    navButtons: true
                };
            }

            // P√°gina de inicio
            kb.inicio = {
                titulo: '<h3 class="font-bold text-[#c3073f] text-sm">üëã ¬°Hola, Artista!</h3>',
                contenido: `
                    <p class="mt-1">Soy tu gu√≠a de la <strong>Escuela "Dilo con Movimiento"</strong>. Estoy aqu√≠ para ayudarte a <strong>recordar y aplicar mejor los conocimientos del a√±o</strong>.</p>
                    
                    <div class="mt-3 p-2 bg-[#1a1a1d] rounded-lg content-section">
                        <h4 class="font-bold text-[#c3073f] mb-1 text-center">üì£ EVENTOS</h4>
                        ${jsonData.eventos.slice(0, 3).map(evento => `
                            <div class="announcement-card">
                                <h5 class="font-bold text-sm">${evento.fecha}: ${evento.titulo}</h5>
                                <p class="text-xs mt-1">${evento.descripcion}</p>
                                ${evento.link ? `<a href="${evento.link}" target="_blank" class="video-link mt-1 block text-xs">üì∑ Ver en Instagram</a>` : ''}
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-3 p-2 bg-[#1a1a1d] rounded-lg content-section">
                        <h4 class="font-bold text-[#c3073f] mb-1 text-center">üéØ RECORDATORIOS</h4>
                        <p class="text-xs">‚Ä¢ <strong>Gala Final:</strong> 10 Ene</p>
                        <p class="text-xs mt-1">‚Ä¢ <strong>Tareas:</strong> 
                            <div class="flex flex-wrap mt-1">
                                <button class="action-button text-xs" onclick="sendMessage('tareas breaking')">Breaking</button>
                                <button class="action-button text-xs" onclick="sendMessage('tareas lira')">Lira</button>
                                <button class="action-button text-xs" onclick="sendMessage('tareas equipo')">Equipo</button>
                            </div>
                        </p>
                        <p class="text-xs mt-1">‚Ä¢ <strong>M√∫sica:</strong> <a href="https://youtube.com/playlist?list=PLthfBcYw9Q18LILg0-6184cg-ywVrNauw&si=oFts-OKgW0Aml8Tj" class="text-blue-400 underline break-words" target="_blank">Playlist</a></p>
                        <p class="text-xs">‚Ä¢ <strong>Calendario:</strong> <a href="https://probaaaaaaaaan.my.canva.site/calendario2026escueladcm" class="text-blue-400 underline break-words" target="_blank">Ver aqu√≠</a></p>
                    </div>

                    <div class="mt-3 p-2 bg-[#1a1a1d] rounded-lg content-section">
                        <h4 class="font-bold text-[#10b981] mb-1 text-center">üìú NORMAS</h4>
                        <div class="safety-warning text-xs">
                            <p class="font-bold text-red-400">‚ö†Ô∏è ACTIVIDADES DE RIESGO</p>
                            <p class="mt-1">${jsonData.normas.advertencia}</p>
                        </div>
                        <ul class="text-xs space-y-1 mt-1 list-disc list-inside">
                            ${jsonData.normas.reglas.slice(0, 4).map(regla => `<li>${regla}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="mt-3 p-2 bg-[#1a1a1d] rounded-lg content-section">
                        <h4 class="font-bold text-[#c3073f] mb-1 text-center">üìö TEMAS DE ESTUDIO</h4>
                        
                        <h5 class="font-bold mt-2 text-sm">‚öñÔ∏è FACTORES DEL ESFUERZO</h5>
                        ${Object.keys(jsonData.factores_esfuerzo || {}).map(factorKey => {
                            const factor = jsonData.factores_esfuerzo[factorKey];
                            return `
                                <div class="process-step" onclick="startProcess('${factorKey}')">
                                    <div class="step-number">${factor.emoji}</div>
                                    <div>
                                        <div class="font-medium text-sm">${factor.nombre}</div>
                                        <div class="text-xs text-gray-400">${factor.descripcion_breve || factor.descripcion.substring(0, 50)}...</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        
                        <h5 class="font-bold mt-2 text-sm">üé≠ PERSONAJES</h5>
                        <div class="process-step" onclick="startProcess('personajes')">
                            <div class="step-number">üë§</div>
                            <div>
                                <div class="font-medium text-sm">Gu√≠a de Personajes</div>
                                <div class="text-xs text-gray-400">Mundo post-apocal√≠ptico</div>
                            </div>
                        </div>
                        
                        <div class="process-step" onclick="startProcess('motores')">
                            <div class="step-number">‚öôÔ∏è</div>
                            <div>
                                <div class="font-medium text-sm">Motores</div>
                                <div class="text-xs text-gray-400">Origen del movimiento</div>
                            </div>
                        </div>
                        
                        <div class="process-step" onclick="startProcess('elementos')">
                            <div class="step-number">üåä</div>
                            <div>
                                <div class="font-medium text-sm">Elementos</div>
                                <div class="text-xs text-gray-400">Fuego, Agua, Aire, Tierra</div>
                            </div>
                        </div>
                        
                        <h5 class="font-bold mt-2 text-sm">üîß HERRAMIENTAS</h5>
                        <div class="process-step" onclick="startProcess('tabla_resumen')">
                            <div class="step-number">üìä</div>
                            <div>
                                <div class="font-medium text-sm">Tabla Resumen</div>
                                <div class="text-xs text-gray-400">Factores del Esfuerzo</div>
                            </div>
                        </div>
                        
                        <div class="process-step" onclick="startProcess('tabla_sintesis')">
                            <div class="step-number">üîó</div>
                            <div>
                                <div class="font-medium text-sm">Tabla S√≠ntesis</div>
                                <div class="text-xs text-gray-400">Integraci√≥n completa</div>
                            </div>
                        </div>
                        
                        <div class="process-step" onclick="startProcess('conocimientos_apoyo')">
                            <div class="step-number">üí™</div>
                            <div>
                                <div class="font-medium text-sm">Conocimientos Apoyo</div>
                                <div class="text-xs text-gray-400">T√©cnicas espec√≠ficas</div>
                            </div>
                        </div>
                    </div>

                    <p class="mt-3 text-xs text-gray-300">üí° <strong>Consejo:</strong> Toca cualquier tema para explorarlo.</p>
                `,
                pregunta: 'Toca un tema o escribe su nombre.',
                navButtons: true
            };

            return kb;
        }

        // Funci√≥n para obtener base de conocimiento por defecto (en caso de error)
        function getDefaultKnowledgeBase() {
            // ... (aqu√≠ ir√≠a la base de conocimiento original como respaldo)
            // Por brevedad, no la incluyo completa pero ser√≠a la que ten√≠as antes
            return {}; // Esto se llenar√≠a con tu knowledgeBase original
        }

        // ... (el resto de las funciones JavaScript se mantienen igual, pero usando chatState.knowledgeBase)
        // Funciones de navegaci√≥n
        window.goBack = function() {
            if (chatState.history.length > 1) {
                chatState.history.pop();
                const previousTopic = chatState.history.pop();
                if (previousTopic) {
                    startProcess(previousTopic);
                } else {
                    goToMenu();
                }
            } else {
                goToMenu();
            }
        };

        window.goToMenu = function() {
            chatState.history = [];
            chatState.currentTopic = null;
            if (chatState.isLoaded && chatState.knowledgeBase.inicio) {
                const response = chatState.knowledgeBase.inicio.titulo + chatState.knowledgeBase.inicio.contenido;
                addMessage(response, 'bot');
            }
        };

        // L√≥gica del bot actualizada para usar chatState.knowledgeBase
        function getBotResponse(userMessage) {
            if (!chatState.isLoaded || !chatState.knowledgeBase) {
                return `<p class="text-sm">Los datos a√∫n se est√°n cargando. Por favor, intenta de nuevo en un momento.</p>`;
            }

            const message = userMessage.toLowerCase().trim();
            
            chatState.messages.push({ type: 'user', content: userMessage, timestamp: new Date().toLocaleTimeString() });

            // Guardar el tema anterior en el historial
            if (chatState.currentTopic) {
                chatState.history.push(chatState.currentTopic);
            }

            // Detecci√≥n de temas (similar a antes pero usando chatState.knowledgeBase)
            const topics = {
                'anuncios': ['anuncios', 'eventos'],
                'normas': ['normas', 'reglas'],
                'peso': ['peso'],
                'tiempo': ['tiempo'],
                'espacio': ['espacio'],
                'flujo': ['flujo', 'flow'],
                'personajes': ['personajes', 'personaje'],
                'motores': ['motores', 'motor'],
                'elementos': ['elementos', 'elemento', 'fuego', 'agua', 'aire', 'tierra'],
                'tabla_resumen': ['tabla resumen', 'resumen'],
                'tabla_sintesis': ['s√≠ntesis', 'sintesis'],
                'conocimientos_apoyo': ['conocimientos', 'apoyo', 't√©cnica'],
                'tareas_breaking': ['tareas breaking', 'tarea breaking'],
                'tareas_lira': ['tareas lira', 'tarea lira'],
                'tareas_equipo': ['tareas equipo', 'tarea equipo'],
                'tareas': ['tareas', 'tarea']
            };

            for (const [topic, keywords] of Object.entries(topics)) {
                if (keywords.some(keyword => message.includes(keyword))) {
                    chatState.currentTopic = topic;
                    return formatResponse(topic);
                }
            }

            if (message.includes('ejemplos') || message.includes('ejemplo')) {
                const topic = chatState.currentTopic || 'peso';
                return showExamples(topic);
            }

            if (message.includes('hola') || message.includes('inicio') || message.includes('menu')) {
                chatState.currentTopic = null;
                chatState.history = [];
                return chatState.knowledgeBase.inicio.titulo + chatState.knowledgeBase.inicio.contenido;
            }

            // Respuesta por defecto
            return `
            <p class="text-sm">No entend√≠ eso. Prueba con uno de estos temas:</p>
            <div class="flex flex-wrap gap-1 mt-2">
                <button class="concept-tag" onclick="startProcess('peso')">Peso</button>
                <button class="concept-tag" onclick="startProcess('tiempo')">Tiempo</button>
                <button class="concept-tag" onclick="startProcess('espacio')">Espacio</button>
                <button class="concept-tag" onclick="startProcess('flujo')">Flujo</button>
                <button class="concept-tag" onclick="startProcess('personajes')">üé≠ Pers</button>
                <button class="concept-tag" onclick="sendMessage('tareas breaking')">üîÑ Brk</button>
                <button class="concept-tag" onclick="sendMessage('tareas lira')">üîÑ Lira</button>
                <button class="concept-tag" onclick="startProcess('normas')">üìú Norm</button>
                <button class="concept-tag" onclick="startProcess('anuncios')">üì£ Anun</button>
            </div>
            ${getNavigationButtons()}
            `;
        }

        // Funci√≥n para formatear respuestas con navegaci√≥n
        function formatResponse(topic) {
            if (!chatState.knowledgeBase[topic]) {
                return `<p class="text-sm">El tema "${topic}" no est√° disponible.</p>${getNavigationButtons()}`;
            }
            
            const content = chatState.knowledgeBase[topic].titulo + chatState.knowledgeBase[topic].contenido;
            const question = chatState.knowledgeBase[topic].pregunta ? 
                `<p class="mt-2 font-medium text-sm">${chatState.knowledgeBase[topic].pregunta}</p>` : '';
            
            const navButtons = chatState.knowledgeBase[topic].navButtons ? getNavigationButtons() : '';
            
            return content + question + navButtons;
        }

        // Funci√≥n para obtener botones de navegaci√≥n
        function getNavigationButtons() {
            return `
            <div class="nav-buttons-container">
                <button class="nav-button text-xs" onclick="goBack()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
                        <path d="m15 18-6-6 6-6"/>
                    </svg>
                    Atr√°s
                </button>
                <button class="nav-button text-xs" onclick="goToMenu()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                    Men√∫
                </button>
            </div>
            `;
        }

        // Funciones Auxiliares de Interfaz
        window.showExamplesWrapper = function(topic) {
            const exampleContent = showExamples(topic);
            addMessage(exampleContent, 'bot');
        }

        function showExamples(topic) {
            // Esta funci√≥n podr√≠a expandirse para mostrar ejemplos espec√≠ficos
            return `<p class="text-sm">Los ejemplos se muestran en cada secci√≥n espec√≠fica.</p>${getNavigationButtons()}`;
        }
        
        // Funciones Globales para HTML (onclick)
        window.startProcess = function(step) {
            chatState.currentTopic = step;
            const response = getBotResponse(step);
            addMessage(response, 'bot');
        };

        window.quickAccess = function(concept) {
            sendMessage(concept);
        };

        window.sendMessage = function(message) {
            const input = document.getElementById('user-input');
            input.value = message;
            document.getElementById('chat-form').dispatchEvent(new Event('submit', { cancelable: true }));
        };

        // Manejador de Formulario Principal
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message) return;

            addMessage(message, 'user');
            input.value = '';

            setTimeout(() => {
                const response = getBotResponse(message);
                addMessage(response, 'bot');
                
                chatState.messages.push({
                    type: 'bot', 
                    content: 'Respondi√≥ a: ' + message,
                    timestamp: new Date().toLocaleTimeString()
                });
            }, 500);
        });

        function addMessage(content, sender) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `chat-bubble max-w-[90%] sm:max-w-[85%] ${
                sender === 'user' 
                    ? 'bg-[#c3073f] ml-auto rounded-2xl rounded-tr-none' 
                    : 'bg-[#3b3b3f] rounded-2xl rounded-tl-none'
            } p-3`;
            
            messageDiv.innerHTML = content;
            container.appendChild(messageDiv);
            
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    messageDiv.style.opacity = 1;
                    messageDiv.style.transform = 'translateY(0)';
                });
            });
            
            container.scrollTop = container.scrollHeight;
        }

        // Funci√≥n para habilitar la interfaz despu√©s de cargar
        function enableInterface() {
            document.getElementById('user-input').disabled = false;
            document.querySelector('#chat-form button[type="submit"]').disabled = false;
            
            // Actualizar botones del footer
            const footerButtons = document.querySelector('.footer-buttons');
            footerButtons.innerHTML = `
                <button class="action-button text-xs" onclick="sendMessage('ejemplos')">üí° Ejemplos</button>
                <button class="action-button text-xs" onclick="sendMessage('personajes')">üé≠ Pers</button>
                <button class="action-button text-xs" onclick="sendMessage('tareas breaking')">üîÑ Brk</button>
                <button class="action-button text-xs" onclick="sendMessage('tareas lira')">üîÑ Lira</button>
                <button class="action-button text-xs" onclick="sendMessage('tareas equipo')">üë• Eq</button>
                <button class="action-button text-xs" onclick="sendMessage('normas')">üìú Norm</button>
                <button class="action-button text-xs" onclick="sendMessage('tabla resumen')">üìä Res</button>
                <button class="action-button text-xs" onclick="sendMessage('anuncios')">üì£ Anun</button>
            `;
        }

        // Inicializaci√≥n
        async function initializeApp() {
            console.log("üîÑ Cargando gu√≠a de estudio...");
            
            try {
                chatState.knowledgeBase = await loadKnowledgeBase();
                chatState.isLoaded = true;
                
                console.log("‚úÖ Gu√≠a de Estudio 'Dilo con Movimiento' cargada desde JSON.");
                
                // Limpiar mensaje de carga y mostrar bienvenida
                const container = document.getElementById('chat-container');
                container.innerHTML = '';
                
                // Mostrar mensaje de bienvenida
                const welcomeMessage = chatState.knowledgeBase.inicio.titulo + chatState.knowledgeBase.inicio.contenido;
                addMessage(welcomeMessage, 'bot');
                
                // Habilitar interfaz
                enableInterface();
                
            } catch (error) {
                console.error("‚ùå Error cargando la gu√≠a:", error);
                const container = document.getElementById('chat-container');
                container.innerHTML = '';
                addMessage('<p class="text-sm text-red-400">‚ùå Error cargando los datos. Por favor, recarga la p√°gina.</p>', 'bot');
            }
        }

        // Ajustar altura del contenedor de chat
        function adjustChatHeight() {
            const chatContainer = document.getElementById('chat-container');
            const header = document.querySelector('header');
            const footer = document.querySelector('footer');
            
            if (window.innerWidth <= 640) {
                const viewportHeight = window.innerHeight;
                const headerHeight = header.offsetHeight;
                const footerHeight = footer.offsetHeight;
                const chatHeight = viewportHeight - headerHeight - footerHeight - 10;
                
                chatContainer.style.height = `${chatHeight}px`;
                chatContainer.style.maxHeight = `${chatHeight}px`;
            } else {
                chatContainer.style.height = '';
                chatContainer.style.maxHeight = '';
            }
        }

        // Iniciar la aplicaci√≥n cuando se carga la p√°gina
        window.addEventListener('load', () => {
            initializeApp();
            adjustChatHeight();
        });
        window.addEventListener('resize', adjustChatHeight);
        window.addEventListener('orientationchange', adjustChatHeight);
    </script>
</body>
</html>
